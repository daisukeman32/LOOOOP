<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src 'self' file: data:; img-src 'self' data:;">
    <title>LOOOOP - プロフェッショナル向けループ動画作成ツール</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- モード切り替えボタン -->
        <div class="theme-toggle">
            <button id="themeToggle" class="theme-toggle-btn" title="Day/Night モード切替">
                <span class="theme-icon" id="themeIcon">🌞</span>
            </button>
        </div>
        
        <!-- メイン画面レイアウト（上半分：メディアプール35% + プレビュー65%） -->
        <div class="main-layout">
            <!-- 左側: メディアプール（35%） -->
            <div class="media-pool">
                <h3>メディアプール</h3>
                <div class="media-pool-content" id="mediaPool">
                    <div class="import-area" id="importArea">
                        <div class="import-placeholder">
                            <div class="import-icon">📁</div>
                            <p>動画ファイルをドロップ<br>または クリックで選択</p>
                            <button class="import-button" id="importButton">ファイルを選択</button>
                        </div>
                    </div>
                </div>
                
                <!-- ループ回数設定 -->
                <div class="loop-count-section">
                    <label>ループ回数</label>
                    <div class="controls-row">
                        <input type="number" id="loopCount" min="1" max="99" value="3">
                        <button class="set-button" id="setToTimeline">セット</button>
                    </div>
                </div>
            </div>

            <!-- 右側: プレビューパネル（65%） -->
            <div class="preview-panel">
                <h3>ループ動画プレビュー</h3>
                <div class="preview-content">
                    <div class="video-container" id="videoContainer">
                        <!-- Canvas要素でループプレビュー -->
                        <canvas id="previewCanvas" width="640" height="480"></canvas>
                        <!-- 隠しVideo要素（フレーム抽出用） -->
                        <video id="hiddenVideo" style="display: none;" preload="metadata" muted></video>
                        <div class="preview-overlay" id="previewOverlay">
                            <div class="preview-placeholder">
                                <div class="preview-icon">🎬</div>
                                <p>動画をセットしてループプレビューを開始</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- フレーム情報のみ（シークバーはタイムラインに統合） -->
                    <div class="preview-info">
                        <div class="frame-info">
                            <span id="currentFrame">0</span> / <span id="totalFrames">0</span> frames | 
                            ループ <span id="currentLoop">0</span> / <span id="totalLoops">0</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- 下部: タイムライン -->
        <div class="timeline-panel">
            <h3>タイムライン</h3>
            
            <!-- シークバーとコントロール -->
            <div class="timeline-seekbar-container">
                <div class="playback-controls">
                    <button id="playBtn" class="control-btn">▶️</button>
                    <button id="pauseBtn" class="control-btn" style="display: none;">⏸️</button>
                    <button id="stopBtn" class="control-btn">⏹️</button>
                </div>
                <div class="seekbar-container">
                    <input type="range" id="timelineSeekbar" class="timeline-seekbar" min="0" max="100" value="0">
                    <div class="time-display">
                        <span id="currentTimeDisplay">00:00</span>
                        <span>/</span>
                        <span id="totalTimeDisplay">00:00</span>
                        <div class="speed-info" id="speedInfo">
                            <small>平均速度: <span id="averageSpeedDisplay">1.0x</span></small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="timeline-content" id="timeline">
                <div class="timeline-ruler">
                    <div class="ruler-markers" id="rulerMarkers"></div>
                </div>
                
                <!-- 速度曲線レーン（タイムライン内に統合） -->
                <div class="speed-lane">
                    <div class="lane-label">速度</div>
                    <svg id="speedCurveTimeline" class="speed-curve-timeline" width="100%" height="60">
                        <defs>
                            <linearGradient id="speedGradientTL" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:var(--accent-color);stop-opacity:0.2" />
                                <stop offset="100%" style="stop-color:var(--accent-color);stop-opacity:0" />
                            </linearGradient>
                        </defs>
                        <rect width="100%" height="60" fill="var(--bg-tertiary)" />
                        <line x1="0" y1="30" x2="800" y2="30" stroke="var(--border-secondary)" stroke-width="1" stroke-dasharray="2,2" opacity="0.5" />
                        <path id="speedPathTimeline" d="M0,30 L800,30" fill="none" stroke="var(--accent-color)" stroke-width="2" />
                        <path id="speedAreaTimeline" d="M0,30 L800,30 L800,60 L0,60 Z" fill="url(#speedGradientTL)" opacity="0.3" />
                    </svg>
                </div>
                
                <div class="timeline-track" id="timelineTrack">
                    <div class="timeline-placeholder">
                        <p>ここにクリップをセットして編集を開始</p>
                    </div>
                    <div class="playhead" id="playhead"></div>
                </div>
                <div class="timeline-controls">
                    <div class="timeline-controls-left">
                        <span class="timeline-info" id="timelineInfo">セット待機中...</span>
                        <div class="timeline-help">
                            <small>💡 ドラッグで並び替え | Ctrl+S: セット | Delete: 削除 | Space: 再生/停止</small>
                        </div>
                    </div>
                    <div class="timeline-controls-right">
                        <button class="timeline-delete-btn" id="deleteSelectedClip" title="選択クリップを削除 (Delete)" disabled>
                            🗑️ 削除
                        </button>
                        <button class="timeline-clear-btn" id="clearTimeline" title="タイムラインをクリア">
                            🔄 クリア
                        </button>
                    </div>
                </div>
            
            <!-- 統合された速度曲線エディタ（詳細制御） -->
            <div class="speed-curve-editor">
                <div class="speed-curve-header">
                    <h4>速度曲線エディタ（リアルタイム制御）</h4>
                    <div class="speed-curve-help">
                        Left Click: 支点追加 | Right Click: 支点削除 | Drag: 位置調整 | 変更は即座に反映
                    </div>
                    <div class="speed-curve-buttons">
                        <button class="reset-button" id="resetSpeedCurveWide">リセット</button>
                    </div>
                </div>
            <canvas id="speedCurveCanvas" width="800" height="200" style="
                width: 100%;
                height: 200px;
                border: 1px solid var(--border-primary);
                border-radius: 8px;
                background: var(--bg-primary);
                cursor: crosshair;
                display: block;
            "></canvas>
            
            </div> <!-- timeline-panel 終了 -->
        </div> <!-- main content wrapper 終了 -->
    </div>

    <!-- ファイル入力（非表示） -->
    <input type="file" id="fileInput" accept="video/*" style="display: none;" multiple>
    
    <script src="loopEngine.js"></script>
    <script src="app.js"></script>
</body>
</html>