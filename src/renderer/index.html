<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src 'self' file: data:; img-src 'self' data:;">
    <title>LOOOOP - プロフェッショナル向けループ動画作成ツール</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- モード切り替えボタン -->
        <div class="theme-toggle">
            <button id="themeToggle" class="theme-toggle-btn" title="Day/Night モード切替">
                <span class="theme-icon" id="themeIcon">🌞</span>
            </button>
        </div>
        
        <!-- メイン画面レイアウト（上半分：メディアプール35% + プレビュー65%） -->
        <div class="main-layout">
            <!-- 左側: メディアプール（35%） -->
            <div class="media-pool">
                <h3>メディアプール</h3>
                <div class="media-pool-content" id="mediaPool">
                    <div class="import-area" id="importArea">
                        <div class="import-placeholder">
                            <div class="import-icon">📁</div>
                            <p>動画ファイルをドロップ<br>または クリックで選択</p>
                            <button class="import-button" id="importButton">ファイルを選択</button>
                        </div>
                    </div>
                </div>
                
                <!-- ループ回数設定 -->
                <div class="loop-count-section">
                    <label>ループ回数</label>
                    <div class="controls-row">
                        <input type="number" id="loopCount" min="1" max="99" value="3">
                        <button class="set-button" id="setToTimeline">セット</button>
                    </div>
                </div>
            </div>

            <!-- 右側: プレビューパネル（65%） -->
            <div class="preview-panel">
                <h3>ループ動画プレビュー</h3>
                <div class="preview-content">
                    <div class="video-container" id="videoContainer">
                        <!-- Canvas要素でループプレビュー -->
                        <canvas id="previewCanvas" width="640" height="480"></canvas>
                        <!-- 隠しVideo要素（フレーム抽出用） -->
                        <video id="hiddenVideo" style="display: none;" preload="metadata" muted></video>
                        <div class="preview-overlay" id="previewOverlay">
                            <div class="preview-placeholder">
                                <div class="preview-icon">🎬</div>
                                <p>動画をセットしてループプレビューを開始</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- フレーム情報のみ（シークバーはタイムラインに統合） -->
                    <div class="preview-info">
                        <div class="frame-info">
                            <span id="currentFrame">0</span> / <span id="totalFrames">0</span> frames | 
                            ループ <span id="currentLoop">0</span> / <span id="totalLoops">0</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- 下部: タイムライン -->
        <div class="timeline-panel">
            <h3>タイムライン</h3>
            
            
            <!-- Adobe Premiere Pro風統合タイムライン -->
            <div class="professional-timeline" id="professionalTimeline">
                
                <!-- 時間軸ルーラー（上部） -->
                <div class="timeline-ruler" id="timelineRuler">
                    <div class="ruler-scale" id="rulerScale">
                        <!-- 時間マーカーは動的生成 -->
                    </div>
                </div>
                
                <!-- メイントラック（クリップ表示+シーク統合） -->
                <div class="main-track-container" id="mainTrackContainer">
                    <!-- 速度曲線ビジュアライザー（背景） -->
                    <div class="speed-curve-background" id="speedCurveBackground">
                        <canvas id="miniSpeedCurve" width="800" height="80"></canvas>
                    </div>
                    
                    <!-- クリップトラック -->
                    <div class="clip-track" id="clipTrack">
                        <div class="track-placeholder" id="trackPlaceholder">
                            <div class="placeholder-content">
                                <span class="placeholder-icon">🎬</span>
                                <span class="placeholder-text">クリップをドラッグしてタイムラインに配置</span>
                            </div>
                        </div>
                        
                        <!-- クリップコンテナ（ドラッグ&ドロップ対応） -->
                        <div class="clips-container" id="clipsContainer">
                            <!-- クリップは動的に生成 -->
                        </div>
                    </div>
                    
                    <!-- プレイヘッド（ドラッグ可能なシーカー） -->
                    <div class="playhead-container" id="playheadContainer">
                        <div class="playhead-line" id="playheadLine"></div>
                        <div class="playhead-handle" id="playheadHandle">
                            <div class="playhead-triangle"></div>
                        </div>
                    </div>
                    
                    <!-- 選択範囲インジケーター -->
                    <div class="selection-overlay" id="selectionOverlay"></div>
                </div>
                
                
                <!-- タイムライン情報バー -->
                <div class="timeline-info-bar" id="timelineInfoBar">
                    <div class="timeline-stats">
                        <span class="time-display">
                            <span id="currentTimeDisplay">00:00.00</span> / <span id="totalTimeDisplay">00:00.00</span>
                        </span>
                        <span class="frame-info" id="frameInfoDisplay">Frame: 0/0</span>
                        <span class="speed-info" id="speedInfoDisplay">Speed: 1.00x</span>
                    </div>
                    <div class="timeline-zoom">
                        <button class="zoom-btn" id="zoomOut" title="ズームアウト">－</button>
                        <span class="zoom-level" id="zoomLevel">100%</span>
                        <button class="zoom-btn" id="zoomIn" title="ズームイン">＋</button>
                    </div>
                </div>
            </div>
                <div class="timeline-controls">
                    <div class="timeline-controls-left">
                        <div class="playback-controls" style="display: inline-flex; gap: 8px; margin-right: 16px;">
                            <button id="playBtn" class="control-btn" style="padding: 4px 8px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--text-primary);">▶️</button>
                            <button id="pauseBtn" class="control-btn" style="display: none; padding: 4px 8px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--text-primary);">⏸️</button>
                            <button id="stopBtn" class="control-btn" style="padding: 4px 8px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--text-primary);">⏹️</button>
                        </div>
                        <span class="timeline-info" id="timelineInfo">セット待機中...</span>
                        <div class="timeline-help">
                            <small>💡 ドラッグで並び替え | Ctrl+S: セット | Delete: 削除 | Space: 再生/停止</small>
                        </div>
                    </div>
                    <div class="timeline-controls-right">
                        <button class="timeline-delete-btn" id="deleteSelectedClip" title="選択クリップを削除 (Delete)" disabled>
                            🗑️ 削除
                        </button>
                        <button class="timeline-clear-btn" id="clearTimeline" title="タイムラインをクリア">
                            🔄 クリア
                        </button>
                    </div>
                </div>
            
            <!-- 統合された速度曲線エディタ（詳細制御） -->
            <div class="speed-curve-editor">
                <div class="speed-curve-header">
                    <h4>速度曲線エディタ（リアルタイム制御）</h4>
                    <div class="speed-curve-help">
                        Left Click: 支点追加 | Right Click: 支点削除 | Drag: 位置調整 | 変更は即座に反映
                    </div>
                    <div class="speed-curve-buttons">
                        <button class="reset-button" id="resetSpeedCurveWide">リセット</button>
                    </div>
                </div>
            <canvas id="speedCurveCanvas" width="800" height="200" style="
                width: 100%;
                height: 200px;
                border: 1px solid var(--border-primary);
                border-radius: 8px;
                background: var(--bg-primary);
                cursor: crosshair;
                display: block;
            "></canvas>
            
            </div> <!-- timeline-panel 終了 -->
        </div> <!-- main content wrapper 終了 -->
    </div>

    <!-- ファイル入力（非表示） -->
    <input type="file" id="fileInput" accept="video/*" style="display: none;" multiple>
    
    <script src="loopEngine.js"></script>
    <script src="app.js"></script>
</body>
</html>